name: Build and Release GDExtension

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  release:
    types: [created]
  workflow_dispatch:

env:
  EOS_SDK_URL: 'https://onlineservices.epicgames.com/api/sdk/download?archive_id=774&archive_type=sdk'

jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Init submodules
        run: git submodule update --init --recursive
      - name: Cache godot-cpp build
        uses: actions/cache@v4
        with:
          path: godot_epic_extension/godot-cpp/bin
          key: ${{ runner.os }}-godotcpp-${{ hashFiles('godot_epic_extension/godot-cpp/src/**', 'godot_epic_extension/godot-cpp/SConstruct', 'godot_epic_extension/godot-cpp/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-godotcpp-
      - name: Download EOS SDK
        run: |
          curl -L -o eos_sdk.zip "${{ env.EOS_SDK_URL }}"
          rm -rf eos_sdk
          unzip -q eos_sdk.zip
          if [ -d "SDK" ]; then
            mv SDK eos_sdk
          else
            SDK_ROOT=$(find . -maxdepth 1 -type d -name 'EOS-SDK-*' | head -n 1)
            if [ -n "$SDK_ROOT" ] && [ -d "$SDK_ROOT/SDK" ]; then
              mv "$SDK_ROOT/SDK" eos_sdk
              rm -rf "$SDK_ROOT"
            else
              echo "Failed to find EOS SDK root directory" >&2
              exit 1
            fi
          fi
          ls -R eos_sdk || true
      - name: Log EOS SDK structure (Linux)
        run: |
          echo "Current working directory: $(pwd)"
          echo "Contents of eos_sdk (depth 2):"
          find eos_sdk -maxdepth 2 -type d -print
          echo "Key files found:" && find eos_sdk -maxdepth 3 -type f \( -name 'eos_sdk.h' -o -name 'libEOSSDK-Linux-Shipping.so' -o -name 'EOSSDK-Win64-Shipping.dll' \) -print
          ls -l eos_sdk/Include | head -n 40 || true
          ls -l eos_sdk/Bin || true
      - name: Install SCons
        run: sudo apt-get install -y scons
      - name: Build Linux x86_64 Debug
        working-directory: godot_epic_extension
        run: scons platform=linux arch=x86_64 target=template_debug EOS_SDK_PATH=../eos_sdk
      - name: Build Linux x86_64 Release
        working-directory: godot_epic_extension
        run: scons platform=linux arch=x86_64 target=template_release EOS_SDK_PATH=../eos_sdk
      - name: Upload Linux x86_64 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotepic-linux-x86_64
          path: godot_epic_extension/demo/bin/**

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Init submodules
        run: git submodule update --init --recursive
      - name: Cache godot-cpp build
        uses: actions/cache@v4
        with:
          path: godot_epic_extension/godot-cpp/bin
          key: ${{ runner.os }}-godotcpp-${{ hashFiles('godot_epic_extension/godot-cpp/src/**', 'godot_epic_extension/godot-cpp/SConstruct', 'godot_epic_extension/godot-cpp/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-godotcpp-
      - name: Install SCons
        run: brew install scons
      - name: Download EOS SDK
        run: |
          curl -L -o eos_sdk.zip "${{ env.EOS_SDK_URL }}"
          rm -rf eos_sdk
          unzip -q eos_sdk.zip
          if [ -d "SDK" ]; then
            mv SDK eos_sdk
          else
            SDK_ROOT=$(find . -maxdepth 1 -type d -name 'EOS-SDK-*' | head -n 1)
            if [ -n "$SDK_ROOT" ] && [ -d "$SDK_ROOT/SDK" ]; then
              mv "$SDK_ROOT/SDK" eos_sdk
              rm -rf "$SDK_ROOT"
            else
              echo "Failed to find EOS SDK root directory" >&2
              exit 1
            fi
          fi
          ls -R eos_sdk || true
      - name: Log EOS SDK structure (macOS)
        run: |
          echo "Current working directory: $(pwd)"
          echo "Contents of eos_sdk (depth 2):"
          find eos_sdk -maxdepth 2 -type d -print
          echo "Key files found:" && find eos_sdk -maxdepth 3 -type f \( -name 'eos_sdk.h' -o -name 'libEOSSDK-Mac-Shipping.dylib' -o -name 'EOSSDK-Win64-Shipping.dll' \) -print
          ls -l eos_sdk/Include | head -n 40 || true
          ls -l eos_sdk/Bin || true
      - name: Build Mac
        working-directory: godot_epic_extension
        run: scons platform=macos target=template_release EOS_SDK_PATH=../eos_sdk
      - name: Upload Mac Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotepic-macos
          path: godot_epic_extension/demo/bin/**

  build-windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Init submodules
        run: git submodule update --init --recursive
      - name: Cache godot-cpp build
        uses: actions/cache@v4
        with:
          path: godot_epic_extension/godot-cpp/bin
          key: ${{ runner.os }}-godotcpp-${{ hashFiles('godot_epic_extension/godot-cpp/src/**', 'godot_epic_extension/godot-cpp/SConstruct', 'godot_epic_extension/godot-cpp/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-godotcpp-
      - name: Install SCons
        run: pip install scons
      - name: Download EOS SDK
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $url = '${{ env.EOS_SDK_URL }}'
          Invoke-WebRequest -Uri $url -OutFile 'eos_sdk.zip'
          if (Test-Path 'eos_sdk_extract') { Remove-Item 'eos_sdk_extract' -Recurse -Force }
          Expand-Archive -Path 'eos_sdk.zip' -DestinationPath 'eos_sdk_extract'
          if (Test-Path 'eos_sdk') { Remove-Item 'eos_sdk' -Recurse -Force }
          $topLevelSdk = Join-Path 'eos_sdk_extract' 'SDK'
          if (Test-Path $topLevelSdk) {
            Move-Item -Path $topLevelSdk -Destination 'eos_sdk'
          } else {
            $archiveDir = Get-ChildItem -Path 'eos_sdk_extract' -Directory | Where-Object { $_.Name -like 'EOS-SDK-*' } | Select-Object -First 1
            if (-not $archiveDir) {
              throw 'Failed to locate EOS SDK archive directory.'
            }
            $nestedSdk = Join-Path $archiveDir.FullName 'SDK'
            if (-not (Test-Path $nestedSdk)) {
              throw "Located archive directory '$($archiveDir.FullName)' but it does not contain an SDK folder."
            }
            Move-Item -Path $nestedSdk -Destination 'eos_sdk'
          }
          Remove-Item 'eos_sdk_extract' -Recurse -Force
          Get-ChildItem -Recurse eos_sdk || Write-Output 'eos_sdk not found'
      - name: Log EOS SDK structure (Windows)
        shell: pwsh
        run: |
          Write-Host "Current working directory: $(Get-Location)"
          Write-Host "Directory tree (depth 2):"
          Get-ChildItem -Path eos_sdk -Depth 2 | ForEach-Object { $_.FullName }
          Write-Host "Key files present:"; @( 'Include/eos_sdk.h', 'Bin/EOSSDK-Win64-Shipping.dll', 'Bin/libEOSSDK-Linux-Shipping.so', 'Bin/libEOSSDK-Mac-Shipping.dylib' ) | ForEach-Object {
            $path = Join-Path eos_sdk $_
            if (Test-Path $path) { Write-Host "  ✓ $path" } else { Write-Host "  ✗ $path" }
          }
          Get-ChildItem -Path eos_sdk/Include | Select-Object -First 40 | Format-Table -AutoSize
          Get-ChildItem -Path eos_sdk/Bin | Format-Table -AutoSize
      - name: Build Windows x86_64
        shell: pwsh
        working-directory: godot_epic_extension
        run: scons platform=windows arch=x86_64 target=template_release EOS_SDK_PATH=../eos_sdk
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotepic-windows-x86_64
          path: godot_epic_extension/demo/bin/**

  release:
    needs:
      - build-linux-x86_64
      - build-macos
      - build-windows-x86_64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: godotepic-linux-x86_64
          path: artifacts/linux/x86_64

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: godotepic-macos
          path: artifacts/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: godotepic-windows-x86_64
          path: artifacts/windows/x86_64

      - name: Create bin directories in addons
        run: |
          mkdir -p addons/godot_epic/bin/linux
          mkdir -p addons/godot_epic/bin/macos
          mkdir -p addons/godot_epic/bin/windows

      - name: Copy downloaded build artifacts into addons
        run: |
          set -e
          if [ -d artifacts/linux/x86_64 ]; then
            cp -a artifacts/linux/x86_64/. addons/godot_epic/bin/linux/ || true
          fi
          if [ -d artifacts/macos ]; then
            cp -a artifacts/macos/. addons/godot_epic/bin/macos/ || true
          fi
          if [ -d artifacts/windows/x86_64 ]; then
            cp -a artifacts/windows/x86_64/. addons/godot_epic/bin/windows/ || true
          fi

      - name: Show contents of addons/bin for debug
        run: |
          echo "Listing addons/godot_epic/bin"
          ls -R addons/godot_epic/bin || true

      - name: Zip entire addons folder with tag name
        shell: bash
        run: zip -r "GodotEpic_${{ github.ref_name }}.zip" addons

      - name: Create Release with named zip
        uses: softprops/action-gh-release@v2
        with:
          files: GodotEpic_${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
